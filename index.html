<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BuddAI | 3D Printing Diagnostic Engine</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--dark); line-height: 1.6; height: 100vh; display: flex; flex-direction: column; }
        
        header { background: var(--dark); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--primary); }
        .db-status { font-size: 0.8rem; background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 20px; }
        
        main { display: grid; grid-template-columns: 350px 1fr; gap: 1rem; padding: 1rem; flex: 1; min-height: 0; }
        
        .sidebar { background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .search-bar { padding: 1rem; border-bottom: 1px solid var(--border); }
        .search-bar input { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; outline: none; }
        .category-list { overflow-y: auto; flex: 1; padding: 0.5rem; }
        .cat-item { padding: 0.75rem; border-radius: 8px; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; margin-bottom: 4px; }
        .cat-item:hover { background: #f1f5f9; border-left-color: var(--primary); }
        
        .chat-area { background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; min-height: 0; }
        .messages { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; background: #fdfdfe; }
        
        .msg { max-width: 85%; padding: 1rem; border-radius: 12px; position: relative; }
        .msg-bot { background: white; border: 1px solid var(--border); align-self: flex-start; border-left: 4px solid var(--primary); }
        .msg-user { background: var(--primary); color: white; align-self: flex-end; }
        
        .solution-card { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 1rem; border-radius: 8px; margin-top: 0.75rem; color: #166534; }
        .technical-note { background: #fffbeb; border: 1px solid #fef3c7; padding: 0.75rem; border-radius: 8px; margin-top: 0.5rem; font-size: 0.85rem; }
        .code-snippet { background: #1e293b; color: #e2e8f0; padding: 0.5rem; border-radius: 4px; font-family: monospace; margin-top: 0.5rem; display: block; overflow-x: auto; }
        
        .input-area { padding: 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 1rem; }
        .input-area input { flex: 1; padding: 1rem; border: 2px solid var(--border); border-radius: 10px; font-size: 1rem; outline: none; transition: 0.2s; }
        .input-area input:focus { border-color: var(--primary); }
        .diag-btn { background: var(--primary); color: white; border: none; padding: 0 1.5rem; border-radius: 10px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }

        .progress-overlay { position: fixed; top: 0; left: 0; right: 0; height: 4px; background: #e2e8f0; z-index: 1000; }
        .progress-bar { height: 100%; background: var(--secondary); width: 0%; transition: width 0.3s; }
        
        @media (max-width: 768px) {
            main { grid-template-columns: 1fr; }
            .sidebar { display: none; }
        }
    </style>
</head>
<body>
    <div class="progress-overlay"><div class="progress-bar" id="loadProgress"></div></div>
    
    <header>
        <div>
            <h2><i class="fas fa-microchip"></i> BuddAI Expert</h2>
            <span style="font-size: 0.7rem; opacity: 0.7;">3D Printing Forensic Diagnostic System</span>
        </div>
        <div class="db-status" id="statusText">System Initializing...</div>
    </header>

    <main>
        <div class="sidebar">
            <div class="search-bar">
                <input type="text" id="kbSearch" placeholder="Browse Knowledge Base...">
            </div>
            <div class="category-list" id="catContainer"></div>
        </div>

        <div class="chat-area">
            <div class="messages" id="messageFlow">
                <div class="msg msg-bot">
                    <strong>System Ready:</strong> Describe a symptom, error code, or firmware issue. 
                    I am currently monitoring 1,600+ rules for Marlin, Klipper, and RepRapFirmware.
                </div>
            </div>
            <div class="input-area">
                <input type="text" id="userInput" placeholder="Ex: 'thermal runaway on bed' or 'Marlin z-offset not saving'">
                <button class="diag-btn" id="diagBtn"><i class="fas fa-search"></i> Diagnose</button>
            </div>
        </div>
    </main>

    <script>
        class BuddAI {
            constructor() {
                this.rules = [];
                this.categories = new Map();
                this.isProcessing = false;
                this.init();
            }

            async init() {
                const diagBtn = document.getElementById('diagBtn');
                const userInput = document.getElementById('userInput');
                const kbSearch = document.getElementById('kbSearch');

                diagBtn.onclick = () => this.diagnose();
                userInput.onkeypress = (e) => e.key === 'Enter' && this.diagnose();
                kbSearch.oninput = (e) => this.filterKB(e.target.value);

                await this.loadData();
            }

            async loadData() {
                try {
                    const response = await fetch('https://gist.githubusercontent.com/JamesTheGiblet/3a336658f46d2a2cf2eda9e5ed4ce7f1/raw/94e068f628f1237e23916bdff9e3928723c6a759/my_coding_rules.txt');
                    const text = await response.text();
                    this.parseDataChunked(text);
                } catch (e) {
                    document.getElementById('statusText').innerText = "Data Offline";
                }
            }

            parseDataChunked(text) {
                const lines = text.split('\n');
                let index = 0;
                let currentCat = "General";
                const total = lines.length;

                const process = () => {
                    const startTime = performance.now();
                    // Process for 16ms per frame to stay at 60fps
                    while (performance.now() - startTime < 16 && index < total) {
                        const line = lines[index].trim();
                        
                        if (line.startsWith('# SECTION')) {
                            currentCat = line.split(':')[1]?.trim() || "Hardware";
                        } else if (line.startsWith('/teach')) {
                            const [prob, sol] = line.replace('/teach', '').split(':');
                            const rule = { 
                                id: this.rules.length,
                                category: currentCat,
                                problem: prob?.trim(), 
                                solution: sol?.trim(),
                                explain: "" 
                            };
                            
                            // Peek ahead for explain
                            if (lines[index+1]?.trim().startsWith('/explain')) {
                                rule.explain = lines[index+1].replace('/explain', '').split(':')[1]?.trim();
                                index++;
                            }
                            this.rules.push(rule);
                        }
                        index++;
                    }

                    const progress = (index / total) * 100;
                    document.getElementById('loadProgress').style.width = `${progress}%`;

                    if (index < total) {
                        requestAnimationFrame(process);
                    } else {
                        this.finalizeDB();
                    }
                };
                process();
            }

            finalizeDB() {
                document.getElementById('statusText').innerText = `${this.rules.length} Rules Active`;
                document.getElementById('loadProgress').style.display = 'none';
                this.renderSidebar();
            }

            renderSidebar() {
                const container = document.getElementById('catContainer');
                const cats = [...new Set(this.rules.map(r => r.category))];
                container.innerHTML = cats.map(c => `
                    <div class="cat-item" onclick="app.filterByCat('${c}')">
                        <i class="fas fa-folder"></i> ${c}
                    </div>
                `).join('');
            }

            diagnose() {
                const input = document.getElementById('userInput').value.toLowerCase();
                if (!input) return;

                this.addMessage(input, 'user');
                document.getElementById('userInput').value = '';

                // Weighted search
                const results = this.rules.map(rule => {
                    let score = 0;
                    const prob = rule.problem.toLowerCase();
                    const exp = rule.explain.toLowerCase();
                    
                    if (prob.includes(input)) score += 10;
                    input.split(' ').forEach(word => {
                        if (word.length < 3) return;
                        if (prob.includes(word)) score += 5;
                        if (exp.includes(word)) score += 2;
                    });
                    return { ...rule, score };
                })
                .filter(r => r.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 3);

                this.renderResponse(results);
            }

            renderResponse(results) {
                if (results.length === 0) {
                    this.addMessage("No direct match found in the rulebase. Check spelling or try a broader term like 'under-extrusion'.", 'bot');
                    return;
                }

                let html = `<strong>Diagnosis Found:</strong><br>`;
                results.forEach(res => {
                    html += `
                        <div class="solution-card">
                            <strong>Problem:</strong> ${res.problem}<br>
                            <strong>Solution:</strong> ${res.solution}
                            ${this.detectCode(res.solution)}
                        </div>
                        ${res.explain ? `<div class="technical-note"><strong>Explanation:</strong> ${res.explain}</div>` : ''}
                        <hr style="margin:10px 0; opacity:0.2;">
                    `;
                });
                this.addMessage(html, 'bot');
            }

            detectCode(text) {
                // Extracts G-code or #defines
                const codeMatch = text.match(/(M\d+|G\d+|#define\s+[A-Z0-9_]+)/g);
                return codeMatch ? `<span class="code-snippet">${codeMatch.join(' ')}</span>` : '';
            }

            addMessage(text, side) {
                const flow = document.getElementById('messageFlow');
                const div = document.createElement('div');
                div.className = `msg msg-${side}`;
                div.innerHTML = text;
                flow.appendChild(div);
                flow.scrollTop = flow.scrollHeight;
            }

            filterByCat(cat) {
                const samples = this.rules.filter(r => r.category === cat).slice(0, 3);
                this.renderResponse(samples);
            }
        }

        const app = new BuddAI();
    </script>
</body>
</html>
